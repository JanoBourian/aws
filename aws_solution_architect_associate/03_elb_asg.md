# Scalability and High Availability

* Scalability: 
    * Vertical
        * Increase the size of the instance
    * Horizontal = elasticity
        * Increase the number of instances

* High Availability:
    * The goal is to survive a data center loss
    * It can be passive
        * Multi AZ
    * It can be Active
        * Horizontal Scalability

## Elastic Load Balancing (ELB)

* Load Balances are servers that forward traffic to multiple servers downstream
* Expose a single point of access to your application
* Do regular health checks to your instances
* Provide SSL termination
* Types of load balancer:
    * Classic Load Balancer (CLB)
    * Application Load Balancer (ALB)
    * Network Load Balancer (NLB)
    * Gateway Load Balancer (GWLB)
* Security:
    * Users > HTTP/HTTPS > Loac Balancer > HTTP Restricted to Load Balancer > EC2

### Application Load Balancing (ALB)

* It is in the 7th layer
* Support HTTP/2, HTTP, HTTPS and Websockets
* Routing tables to different target groups:
    * Based on path in URL (example.com/users and example.com/posts)
    * Based on hostname in URL (one.example.com and other.example.com)
    * Based on Query String (example.com/users?id=123&order=false)
* Is great fit for micro services and container based application
* Target Group:
    * EC2 Instances
    * ECS Tasks
    * Lambda functions
    * IP Addresses (Private IP routing)
* The ALB do not see the IP of the client directly
* You need to use X-Forwarded-Port and X-Forwarded-Proto

* Hands on:
    * Create instances
    * Create Aplication Load Balancer
    * Create Target groups
    * Create and edit security groups
    * Launch ALB
    * Block SG to receive only ALB requests
    * You can set rule conditions

```bash
#!/bin/bash
# Use this for your user data (script from top to bottom)
# install httpd (Linux 2 version)
yum update -y
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "<h1>Hello from @janobourian in $(hostname -f)</h1>" > /var/www/html/index.html
```

### Network Load Balancing (NLB)

* TCP and UDP traffic 
* Layer 4
* Million of request per second
* NLB has one static IP per AZ and supports assigning Elastic IP
* Targets groups:
    * EC2 instances
    * IP addresses
    * Application Load Balancer
* Health checks support:
    * TCP
    * HTTP
    * HTTPS

### Gateway Load Balancing (GWLB)

* Deploy, scale, and manage a fleet of third party
* Operates at Layer 3
* It uses GENEVE at 6081 port
* Examples:
    * Firewalls
    * Intrusion Detection
    * Prevention Systems
    * Deep Packet Inspection Systems
    * Payload manipulation

### Elastic Load Balancer

* Sticky Sessions (Session Affinity)
* Cookie Names
    * Application-based Cookies
        * Custom cookie
            * Generated by the target
        * Application cookie
            * Generated by the ELB
    * Duration-based Cookies
        * Generated by the ELB
* You should modify the Target Group
    * Turn on stickiness
    * Modify the duration and the name (when it is an application-based cookie)

* Cross-Zone Load Balancing
    * With Cross Zone Load Balancing:
        * Enable by default: ALB. Not for NLB and GWLB
        * Free for CLB and ALB
        * It can be disabled at The Target Group level
        * Each load balancer instance distributes evenly across all registered instances in all AZ
    * Without Cross Zone Load Balancing:
        * Requests are distributed in the instances of the node of the Elastic Load Balancer

* SSL/TLS Certificates
    * SSL: Allows traffic between your clients and your load balancer to be encrypted in transit
    * SSL: Secure Sockets Layer
    * TLS: Transport Layer Security
    * Public SSL certificates are issued by Certificate Authorities (CA)
        * You can manage certificates using ACM (AWS Certificate Manager)
    * SSL has a time to live
    * SNI (Server Name Indication)
        * solves the problem of loading multiple SSL certificates onto one web server

* Connection Draining
    * Connection Draining or Deregistration Delay

### Auto Scaling Groups

* Overview
    * You can create ad get rid of servers
    * The goal of ASG is:
        * Scale out or scale in
        * Ensure we have a minimum and a maximum of EC2 instance running
        * Is free
    * Steps
        * Create a Launch Template
    * Auto Scaling:
        * CloudWatch Alarms and Scaling

* Scaling Policies
    * Dynamic Scaling
        * Target Tracking Scaling
        * Simple / Step Scaling
    * Scheduled Scaling
    * Predictive Scaling
    * Good metrics to scale on:
        * CPUUtilization: Average CPU utilization across your instances
        * RequestCountPerTarget: to make sure the number of requests per EC2 instanes is stable
        * Averag Network In / Out (if you are application is network bound)
        * Any custom metric
    * Scaling Cooldown